<head>
  <style> body { margin: 0; } </style>

  <script src="//cdn.jsdelivr.net/npm/globe.gl"></script>
  <!--<script src="../../dist/globe.gl.js"></script>-->
</head>

<body>
  <div id="globeViz"></div>

  <script type="module">
    const markerSvg = `<svg viewBox="-4 0 36 36">
      <path fill="currentColor" d="M14,0 C21.732,0 28,5.641 28,12.6 C28,23.963 14,36 14,36 C14,36 0,24.064 0,12.6 C0,5.641 6.268,0 14,0 Z"></path>
      <circle fill="black" cx="14" cy="14" r="7"></circle>
    </svg>`;

    const gElavationData = [
      {
        "name": "peer_1",
        "lat": 0.07 * 180,
        "lon": 0.07 * 360,
        "elevation": 10000
      },
      {
        "name": "peer_2",
        "lat": -0.01 * 180,
        "lon": -0.01 * 360,
        "elevation": 10000
      },
      {
        "name": "peer_3",
        "lat": 0.91 * 180,
        "lon": -0.097 * 360,
        "elevation": 10000
      },
      {
        "name": "peer_4",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_5",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_6",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_7",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_8",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_9",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_10",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_11",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_12",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_13",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_14",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_15",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_16",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_17",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_18",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_19",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_20",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_21",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_22",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_23",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_24",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_25",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_26",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_27",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_28",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
      {
        "name": "peer_29",
        "lat": 34.0549,
        "lon": -118.2426,
        "elevation": 10000
      },
        {
        "name": "peer_30",
        "lat": 40.7128,
        "lon": -74.0060,
        "elevation": 10000
      },
    ]

    function spreadClusterCircle(cluster, radiusDeg = 0.5) {
      const n = cluster.length;
      const centerLat = cluster[0].lat;
      const centerLon = cluster[0].lon;

      if (n === 1) return cluster;

      const nodes = [];
      let placed = 0;
      let layer = 1;

      while (placed < n) {
        // Radius of this layer
        const r = (layer / Math.ceil(Math.sqrt(n))) * radiusDeg;

        // Number of nodes in this layer
        const nodesInLayer = Math.min(n - placed, layer * 6);

        for (let i = 0; i < nodesInLayer && placed < n; i++, placed++) {
          const angle = (i / nodesInLayer) * 2 * Math.PI;
          cluster[placed].lat = centerLat + r * Math.cos(angle);
          cluster[placed].lon = centerLon + r * Math.sin(angle);
        }

        layer++;
      }

      return cluster;
    }

    function spreadOverlappingNodesCircular(peers, radiusDeg = 0.5) {
      function roundCoord(coord, precision = 4) {
        return Math.round(coord * 10 ** precision) / 10 ** precision;
      }

      const clusters = {};
      peers.forEach(peer => {
        const key = `${roundCoord(peer.lat)},${roundCoord(peer.lon)}`;
        if (!clusters[key]) clusters[key] = [];
        clusters[key].push(peer);
      });

      Object.values(clusters).forEach(cluster => {
        if (cluster.length > 1) {
          spreadClusterCircle(cluster, radiusDeg);
        }
      });

      return peers;
    }

    // Spread out the nodes in similar locations
    spreadOverlappingNodesCircular(gElavationData, 10.5);

    function generateArcsData(peers, color = 'white') {
      const arcs = [];

      for (let i = 0; i < peers.length; i++) {
        for (let j = 0; j < peers.length; j++) {
          if (i === j) continue; // skip self-to-self
          arcs.push({
            startLat: peers[i].lat,
            startLng: peers[i].lon,
            endLat: peers[j].lat,
            endLng: peers[j].lon,
            color: color
          });
        }
      }

      return arcs;
    }

    // Usage
    const arcsData = generateArcsData(gElavationData);

    const OPACITY = 0.6;

    const getAlt = d => d.elevation * 5e-5;

    const getTooltip = d => `
      <div style="text-align: center">
        <div><b>${d.name}</b></div>
      </div>
    `;

    const POINT_HEIGHT = 0.06
    const POINT_THICKNESS = 0.03

    fetch('../static/datasets/ne_110m_admin_0_countries.geojson').then(res => res.json()).then(countries =>
    {
      const world = new Globe(document.getElementById('globeViz'))
        .pointOfView({ lat: 39.6, lng: -98.5, altitude: 3 }) // aim at continental US centroid
        .backgroundColor("black")
        .atmosphereColor("null")
        .atmosphereAltitude(0.0)
        .hexPolygonsData(countries.features)
        .hexPolygonResolution(3)
        .hexPolygonMargin(0.3)
        .hexPolygonUseDots(false)
        .hexPolygonColor(() => `grey`)
        .arcDashLength(0.25)
        .arcDashGap(1)
        .arcDashInitialGap(() => Math.random())
        .arcDashAnimateTime(4000)
        .arcColor(d => [`rgba(0, 255, 0, ${OPACITY})`, `rgba(255, 0, 0, ${OPACITY})`])
        .arcsTransitionDuration(0)

        .pointsMerge(true)
        .arcsData(arcsData)

        .pointLat('lat')
        .pointLng('lon')
        .pointAltitude(POINT_HEIGHT)
        .pointRadius(POINT_THICKNESS) // thickness of pointer
        .pointColor(d => 'white') // color of pointer
        .pointLabel(getTooltip)
        .labelLat('lat')
        .labelLng('lon')
        .labelAltitude(POINT_HEIGHT)
        .labelDotRadius(POINT_THICKNESS)
        .labelDotOrientation(() => 'bottom')
        .labelColor(d => 'white') // color of label ontop of pointer
        .labelText('name')
        .labelSize(0.5)
        .labelResolution(1)
        .labelLabel(getTooltip)
        .pointsData(gElavationData)
        .labelsData(gElavationData)
    });
  </script>
</body>